<!DOCTYPE html>
<html lang="ar" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="تسجيل الدخول - منصة التجارة الإلكترونية">
    <title>تسجيل الدخول</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/auth.css">
</head>

<body>
    <div class="auth-container">
        <div class="auth-card">
            <!-- Header -->
            <div class="auth-header">
                <h1 class="auth-title">تسجيل الدخول</h1>
                <p class="auth-subtitle">مرحبًا بعودتك</p>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form">
                <!-- Email -->
                <div class="form-group">
                    <label for="email" class="form-label required">البريد الإلكتروني</label>
                    <input type="email" id="email" name="email" class="form-input" placeholder="example@email.com"
                        required>
                </div>

                <!-- Password -->
                <div class="form-group">
                    <label for="password" class="form-label required">كلمة المرور</label>
                    <input type="password" id="password" name="password" class="form-input"
                        placeholder="أدخل كلمة المرور" required>
                </div>

                <!-- Forgot Password Link -->
                <div class="form-group">
                    <a href="#" id="forgotPasswordLink" class="forgot-link">نسيت كلمة المرور؟</a>
                </div>

                <!-- Submit Button -->
                <button type="submit" id="submitBtn" class="btn btn-primary btn-block btn-lg">
                    دخول
                </button>
            </form>

            <!-- Footer -->
            <div class="auth-footer">
                <p>ليس لديك حساب؟ <a href="register.html">إنشاء حساب جديد</a></p>
            </div>
        </div>

        <!-- Back to Home -->
        <div class="auth-back">
            <a href="index.html">← العودة للصفحة الرئيسية</a>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">استعادة كلمة المرور</h3>
                <button type="button" class="modal-close" onclick="closeModal('forgotPasswordModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="forgotPasswordForm">
                    <div class="form-group">
                        <label for="resetEmail" class="form-label required">البريد الإلكتروني</label>
                        <input type="email" id="resetEmail" name="resetEmail" class="form-input"
                            placeholder="أدخل بريدك الإلكتروني" required>
                        <span class="form-help">سنرسل لك رابط استعادة كلمة المرور</span>
                    </div>
                    <button type="submit" id="resetBtn" class="btn btn-primary btn-block">
                        إرسال رابط الاستعادة
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Redirect if already authenticated
        redirectIfAuthenticated();

        // Login form submission
        const loginForm = document.getElementById('loginForm');

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Clear previous errors
            clearAllErrors('loginForm');

            // Get form data
            const formData = new FormData(loginForm);
            const email = formData.get('email').trim();
            const password = formData.get('password');

            // Validation
            if (!validateEmail(email)) {
                showFieldError('email', 'البريد الإلكتروني غير صحيح');
                return;
            }

            if (!password) {
                showFieldError('password', 'كلمة المرور مطلوبة');
                return;
            }

            // Submit to API
            setButtonLoading('submitBtn', true);

            try {
                const response = await authAPI.login(email, password);

                // Save auth data
                if (response.token && response.username) {
                    saveAuthData(response.token, response.username, response.merchant);
                }

                showToast('تم تسجيل الدخول بنجاح!', 'success');

                // Redirect to dashboard
                setTimeout(() => {
                    window.location.href = `dashboard.html?username=${response.username}`;
                }, 1000);

            } catch (error) {
                console.error('Login error:', error);

                if (error.status === 401) {
                    showToast('البريد الإلكتروني أو كلمة المرور غير صحيحة', 'error');
                } else {
                    showToast(error.message || 'حدث خطأ أثناء تسجيل الدخول', 'error');
                }

                setButtonLoading('submitBtn', false);
            }
        });

        // Forgot password link
        document.getElementById('forgotPasswordLink').addEventListener('click', (e) => {
            e.preventDefault();
            openModal('forgotPasswordModal');
        });

        // Forgot password form submission
        const forgotPasswordForm = document.getElementById('forgotPasswordForm');

        forgotPasswordForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const email = document.getElementById('resetEmail').value.trim();

            if (!validateEmail(email)) {
                showFieldError('resetEmail', 'البريد الإلكتروني غير صحيح');
                return;
            }

            setButtonLoading('resetBtn', true);

            try {
                await authAPI.requestPasswordReset(email);

                showToast('تم إرسال رابط استعادة كلمة المرور إلى بريدك الإلكتروني', 'success');
                closeModal('forgotPasswordModal');
                forgotPasswordForm.reset();

            } catch (error) {
                console.error('Password reset error:', error);
                showToast(error.message || 'حدث خطأ أثناء إرسال رابط الاستعادة', 'error');
            } finally {
                setButtonLoading('resetBtn', false);
            }
        });
    </script>
</body>

</html>